# Define the download URL and file paths
$downloadUrl = "https://pestudio.en.lo4d.com/download/mirror-ex1"
$downloadsFolder = [System.IO.Path]::Combine([System.Environment]::GetFolderPath("UserProfile"), "Downloads")
$fileName = "pestudio.zip"
$zipFilePath = [System.IO.Path]::Combine($downloadsFolder, $fileName)
$extractDir = [System.IO.Path]::Combine($downloadsFolder, "pestudio")

# Download the file
Write-Host "Downloading PeStudio to $downloadsFolder..."
Invoke-WebRequest -Uri $downloadUrl -OutFile $zipFilePath

# Check if the download was successful
if (!(Test-Path $zipFilePath)) {
    Write-Host "Download failed!"
    exit 1
}

# Create the extraction directory
Write-Host "Creating extraction directory..."
New-Item -ItemType Directory -Force -Path $extractDir

# Extract the ZIP file
Write-Host "Extracting the file..."
Add-Type -AssemblyName System.IO.Compression.FileSystem
[System.IO.Compression.ZipFile]::ExtractToDirectory($zipFilePath, $extractDir)

# Check if the extraction was successful
if (!(Test-Path $extractDir)) {
    Write-Host "Extraction failed!"
    exit 1
}

# Find the executable file and run it
Write-Host "Running the application..."
$executable = Get-ChildItem -Path $extractDir -Filter *.exe -Recurse | Select-Object -First 1

if ($null -eq $executable) {
    Write-Host "Executable not found!"
    exit 1
}

# Run the executable
Start-Process -FilePath $executable.FullName

# Cleanup - optionally remove the downloaded ZIP file
Write-Host "Cleaning up..."
Remove-Item -Force $zipFilePath

Write-Host "Done!"
